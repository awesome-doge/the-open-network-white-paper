# 3.1. 抽象資料包表網路層（簡稱 ADNL）

### 3.1	抽象資料包表網路層（簡稱 ADNL）

構建TON網路通訊協定的基礎是（TON）抽象（資料表）網路層。它使所有節點能夠假設某些由256位 “抽象網路位址” 表示的“網路標識”，並且可以使用這些256位網路位址進行通信（給各方發送資料包表作為第一步）以識別發送方和接收方。人們不必擔心IPv4或IPv6位址、UDP 埠號等；它們會被抽象網路層隱藏。

### 3.1.1	抽象網路位址。

一個抽象網路位址或抽象位址，或簡稱位址，是256位元整數，本質上等於256位ECC公開金鑰。公開金鑰可以任意生成，從而根據節點的喜好，創建任意多的不同網路身份。然而，必須知道相應的私密金鑰，才能接收（和解密）用於這種位址的消息。
實際上，地址本身並不是公開金鑰；相反，它是序列化的TL對象（參見 2.2.5）的 256 位雜湊（ Hash = sha256），可以根據其構造函數（前四個位元組）描述幾種類型的公開金鑰和位址。在最簡單的情況下，這個序列化的TL物件只包含一個4位元組的魔術數位和一個256位元的橢圓曲線加密
（ECC）公開金鑰；在這種情況下，位址將等於這個36位元組結構的雜湊值。然而，可以使用2048 位RSA金鑰或任何其他公開金鑰加密方案來取代。
當節點知曉另一個節點的抽象位址時，它還必須接收其 “原象”（即序列化的TL物件，其雜湊
值等於那個抽象地址），否則它將無法加密並將資料包表發送到該地址。

### 3.1.2	較低級別的網路。UDP的實現。

從幾乎所有TON網路元件的角度來看，唯一存在的是能夠（不可靠）將資料包表從一個抽象位址發送到另一個抽象位址的網路（the Abstract Datagram Networking Layer；ADNL）。原則上，抽象資料包網路層（ADNL）可以在不同的現有網路技術上實現。但是，我們將在IPv4
/ IPv6網路（例如 Internet 或 Intranet）中通過UDP實現它，如果UDP不可用，則使用可選的TCP回退。

### 3.1.3	基於UDP最簡單的ADNL的例子。

最簡單地例子是，從發送者的抽象位址向任何其他抽象位址（具有已知的原像）發送資料包表可以用以下方式實現。
假設發送者以某種方式知道擁有目的地抽象位址的接收方的IP位址和UDP埠，也知道接收方和發送方都使用的抽象位址都來源於256位ECC公開金鑰。
在這種情況下，發送者只是增加了將要通過ECC簽名（配合它的私密金鑰完成）和它的源位址
（如果接收者尚不知道源地址的原像，則是發送原像） 發送的資料包表。結果用接收者的公開金鑰加密，嵌入UDP資料包並發送到接收者的已知IP和埠。由於UDP資料包表的前256位包含接收者的抽象位址，因此接收者可以識別應使用哪個私密金鑰來解密資料包的其餘部分。只有在那之後發送者的身份才能被披露。

### 3.1.4	寄件者的明文位址是一種安全性較低的方式。

有時，使用安全性較低的方式就足夠了，即接收者和發送者的位址以明文形式保存在 UDP 資料包中的時候； 發送方的私密金鑰和接收方的公開金鑰組合在一起，使用ECDH（橢圓曲線
Diffie-Hellman）生成一個 256 位的共用金鑰，隨後使用該共用金鑰，還有一起被使用的是未加密部分中包含的隨機256位亂數，以匯出用於加密的AES金鑰。例如，可以通過在加密之前將原始明文資料的雜湊值連接到明文來提供完整性。
這種方法的優點是，如果預計有多份資料包表在兩個位址之間切換，則只能計算一次共用金鑰
，然後進行快取記憶體； 然後，加密或解密下一個資料包表將不再需要較慢的橢圓曲線運算。

### 3.1.5	通道和通道識別字。

在最簡單的情況下，攜帶嵌入式TON ADNL資料包表的UDP資料包表的前256位將等於接收者的地址。然而，總得來說它們構成了通道識別字。有不同類型的通道。其中一些是點對點的； 創建的雙方希望在未來交換大量資料，並生成一個共用秘鑰。實現方式包括通過交換幾個如3.1.3或3.1.4所述的加密資料包，或通過運行經典或橢圓曲線Diffie-Hellman（如果需要額外的安全性），或者只通過一方生成生成隨機共用金鑰並將其發送給另一方。
在此之後，一個通道識別碼由共用秘密與一些附加資料（如發送者和接收者的位址）組合而成
，例如通過雜湊演算法，並且該識別字被用作UDP資料包表的前256位，這些資料包表借助該共用私密金鑰加密。

### 3.1.6	通道作為一種隧道識別字。

通常，“通道” 或 “通道識別字” 僅選擇處理接收器已知的入站UDP資料包表的方式。如果通道是接收者的抽象位址，那麼處理方法就如3.1.3或3.1.4所述；如果通道是 3.1.5 中討論的已建立的點對點通道，則處理過程在於借助共用私密金鑰對資料包表進行解密，如loc. cit.等中解釋的那樣。
特別是，當直接接收者簡單地將所接收的消息轉發給其他人——實際接收者或另一個代理時， 通道識別字實際上可以選擇 “隧道”（tunnel）。一些加密或解密步驟（讓人聯想到 “onion routing”[6] 甚至 “garlic routing”32）可能會在此過程中完成，而另一個通道識別字可能會用於重新加密的轉發資料包（例如，點對點通道可以用來將資料包轉發給路徑上的下一個接收
者）。
通過這種方式，可以在TON抽象資料包網路層的層面上添加一些對 “tunneling” 和 “proxying”
的支援——與TOR或I2P項目提供的類似——而不會影響到所有高層TON抽象資料包表網路協

---

32 [https://geti2p.net/en/docs/how/garlic-routing](https://geti2p.net/en/docs/how/garlic-routing)

---

議的功能，所有高層TON抽象資料包表網路通訊協定對此添加而言都是不可知的。這是利用了
TON Proxy服務（參見 4.1.11）。

### 3.1.7	零通道和bootstrap問題。

通常，TON ADNL節點將具有一些 “相鄰節點列表（neighbor table）”，其包含關於其他已知節點的資訊，例如它們的抽象位址及其原像（即公開金鑰）及其IP位址和UDP埠。然後它將通過使用從這些已知節點獲取的資訊作為特殊查詢的答案逐漸擴展此表，並且有時會有修剪的記錄。
但當TON ADNL節點剛啟動時，可能發生此節點不知道其他節點的情況，只知道節點的IP地址和UDP埠，而不知道其他節點的抽象地址。這種情況會在如下時候發生：例如，如果輕節點無法訪問任何先前緩存的節點以及任何硬編碼到軟體中的節點，並且必須要求用戶輸入節點的IP地址或DNS域，然後通過DNS解決 。
在這種情況下，節點將資料包發送到相關節點的特殊 “零通道”。這不需要知道接收者的公開金鑰
（但消息仍應包含寄件者的身份和簽名），因此消息無需加密即可傳輸。它通常應該僅用於獲取接收器的身份（可能是專門為此創建的一次性身份），然後以更安全的方式開始通信。
一旦知道至少一個節點，就很容易通過更多條目填充 “相鄰節點列表（neighbor table）” 和
“路由表（routing table）”，從發送到已知節點的特殊查詢答案中知道它們。
並非所有節點都需要處理發送到零通道的資料包表，但那些用作bootstrap輕用戶端的節點應該支持這個功能。

### 3.1.8	ADNL上類似TCP的流協議。

ADNL是基於256位抽象地址的不可靠（小規模）資料包表協議，可用作更複雜網路通訊協定的基礎。例如可以使用ADNL作為IP的抽象替代物來構建類似TCP的流協議。但是TON專案的大多數元件都不需要這樣的流協定。

### 3.1.9	RLDP或ADNL上的可靠大資料包表協議。

使用基於ADNL的可靠的任意大小的資料包表協議（稱為 RLDP）代替類似 TCP 的協議。例如，可以使用這種可靠的資料包表協議將RPC查詢發送到遠端主機並通過它們接收回復（參見 4.1.5）。