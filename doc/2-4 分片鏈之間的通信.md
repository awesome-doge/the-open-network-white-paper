# 2.4. 分片鏈之間的通信

TON 的一個重要組成部分是區塊鏈之間的消息傳遞系統。包括相同工作鏈的下的分片鏈和不同工作鏈下的分片鏈。

### 2.4.1	消息，帳戶和交易：系統的一種鳥瞰視角下的。

消息從一個帳戶發送到另一個帳戶。 一個交易包含：一個接收一條消息的帳戶、這個帳戶根據某些規則更改其狀態、以及向其他帳戶生成多個（可能是一個或零個）新消息。 每條消息僅會被生成並被接收（傳遞）一次。
這意味著消息在系統中起著至關重要的作用，與帳戶（智慧合約）相當。 從無限分片範式
（參見 2.1.2）的角度來看，每個帳戶都在其獨立的 “帳戶鏈” 中，並且它影響其他帳戶狀態的唯一方法是發送消息。

### 2.4.2	作為流程或參與者的帳戶；Actor 模型。

有人可能會將帳戶（和智慧合約）視為 “processes” 或 “actors”，它們能夠處理傳入的消息， 更改其內部狀態並生成一些出站消息。 這與所謂的 Actor 模型密切相關，在 Erlang 等語言中使用（然而，Erlang 中的 actor 通常稱為 “processes”）。 由於處理入站消息的結果也允許現有參與者創建新的actors（即，智慧合約），因此與 Actor 模型的對應基本上是完整的。

### 2.4.3	消息接收者。

任何消息都有其接收者，其特徵是目標工作鏈識別字 $w$（預設情況下假定與發起的分片鏈一致）和收件方帳戶 $account\_id$。 $account\_id$ 的確切格式（即位元組數位）取決於 $w$； 但是，分片始終由其首位（最重要的）64 位元組確定。

### 2.4.4	消息發送者。

在大多數情況下，消息具有發送者，再次由$（w'，account_id'）$對表示。它位於消息接收者和消息值之後。  有時，發送者不重要或者是在區塊鏈系統之外（即，並非一個智慧合約），在這種情況下，該欄位不存在。
請注意，Actor 模型不要求消息具有隱式發送者。 相反，消息可以包含對應該發送請求答案的Actor 的引用； 通常它與發送者一致。 但是，在加密貨幣（拜占庭）環境中的消息中具有不可偽造發送者簽名欄位是有用的。

### 2.4.5	消息值。

消息的另一個重要特徵是其附加值，它在由源（source）和目標工作鏈支援的一個或多個代幣中。 消息的值緊接著消息接收者之後顯示； 它本質上是（$currency\_id,value）$對的列表。請注意，“簡單（simple）” 帳戶之間的 “簡單” 值轉移只是空（無操作）消息，並附加了一些值。 另一方面，稍微複雜的消息體可能包含簡單的文本或二進位注釋（例如，關於支付的目的）。

### 2.4.6	“來源不明的消息（messages from nowhere）”。

一些“來源不明的消息”會進入系統——也就是說，它們不是由位於區塊鏈中的帳戶（智慧合約或非智能合約）生成的。一個典型的例子是當用戶想要將一些資金從她控制的帳戶轉移到其他帳戶時，這種情況就會發生。在這種情況下，使用者將一條“來源不明的消息”發送到她自己的帳戶，請求它生成帶有指定值的接收帳戶的消息。如果此消息已正確簽名，則她的帳戶會收到該消息並生成所需的出站消息。

實際上，人們可能會將一個 “簡單” 帳戶視為具有預定義代碼的智慧合約的特例。這個智慧合約只收到一種消息。這樣的入站消息必須包含由於傳遞（處理）入站消息而生成的出站消息清單以及簽名。智慧合約檢查簽名，如果正確，則生成所需的消息。

當然，“來源不明的消息”與正常資訊之間存在差異，因為“來源不明的消息”不能承擔附加值， 因此它們不能自行支付它們的 “Gas”（即它們的processing）。相反，在被包含在一個新的分片區塊之前，它們在有一個小額gas限制的條件下執行；如果執行失敗（簽名不正確），則外部消息被認為是不正確的並被丟棄。如果在執行有小額gas限制的進程時沒有失敗，則消息可以被包含在新的分片區塊中進行完全處理，並從從接收者的帳戶中支取（處理任務所需要的） Gas。“來源不明的消息”還可以定義一些除了用於重新分配給驗證人的gas費用之外的交易費用，它們是從接收方的帳戶中被抵扣。

從這個意義上說，外部消息是來自其他區塊鏈系統（例如，比特幣和乙太坊）的交易候選人。

### 2.4.7	日誌（Log）消息，或 “去向不定的消息（messages to nowhere）”。

類似地，有時可以生成特殊消息並將其導到特定的分片鏈，而不是將其傳遞給其接收者。為了易於任何對接收到的分片更新有疑問的人可觀察，這些消息被記錄下來。這些記錄的消息可以在使用者的控制台中輸出，或者在離線伺服器上觸發某些腳本的執行。 從這個意義上說，它們代表了 “區塊鏈超級電腦” 的外部 “輸出”，就像 外部消息代表 “區塊鏈超級電腦” 的外部
“輸入” 一樣。

### 2.4.8	與鏈下服務和外部區塊鏈互動。

這些外部輸入和輸出消息可用於與鏈下服務和其他（外部）區塊鏈（如比特幣或乙太坊）進行交互。 有人可能會在 TON 區塊鏈內部創建代幣或加密貨幣，並與比特幣、乙太坊或乙太坊區

塊鏈中定義的任何 ERC-20 代幣掛鉤，並使用由腳本生成和處理駐留在某些協力廠商鏈下伺服器上的外部消息和 “去向不定的消息”，以實現 TON區塊鏈與這些外部區塊鏈之間的交互。

### 2.4.9	訊息文字。

訊息文字只是一個位元組序列，其含義僅由接收工作鏈和（或）智慧合約的確定。 對於使用TON VM 的區塊鏈，這可以是通過 Send()操作自動生成的任何 TVM cell 的序列化。 簡單地通過用所引用的 cell 遞迴地替換 TON VM cell 中的所有引用來獲得這種序列化。 最終，出現一串原始位元組，通常由 4 位元組 “消息類型” 或 “消息構造函數” 預先設置，用於選擇接收智慧合約。
另一種選擇是使用 TL 序列化物件（參見 2.2.5）作為消息體。 這對於不同工作鏈之間的通信尤其有用，也許某個工作鏈不使用 TON VM。

### 2.4.10	Gas 限制和其他工作鏈 / VM 特定參數。

有時，消息需要攜帶有關gas限制、gas價格、交易費用以及依賴於接收工作鏈的類似值的資訊，並且僅與接收工作鏈相關，但對於原始工作鏈而言並非必要。 這些參數包含在消息體中或之前，有時（取決於工作鏈）具有特殊的 4 位元組首碼，表明它們的存在（可以通過 TL 方案定義；參見 2.2.5）。

### 2.4.11	創建消息：智慧合約和交易。

這兩個新消息的來源。 大多數消息是在智慧合約執行期間（通過 TON VM 中的 Send()操作） 創建的，此時調用某個智慧合約來處理傳入消息。消息也可能來自外部，作為 “外部消息” 或 “去向不定的消息”（參見 2.4.6）14

### 2.4.12	傳遞資訊。

當消息到達包含其目標帳戶的分片鏈時，它將 “傳遞（delivered）” 到其目標帳戶15。 接下來會發生什麼取決於工作鏈； 從外部的角度來看，重要的是這樣的消息永遠不能從這個分片鏈進一步轉發。

對於基礎工作鏈的分片鏈，交付包括將附帶數值（減去任何 gas 支付）添加到接收帳戶的餘額，如果收款帳戶是智慧合約則根據消息的規則來調用。實際上，智慧合約只有一個用於處理所有傳入消息的入口點，它必須通過查看它們的前幾個位元組來區分不同類型的消息（例如，包含 TL 構造函數的前四個位元組；參見 2.2.5 ）。

### 2.4.13	消息的傳遞是一種交易。

因為消息的傳遞改變了帳戶或智慧合約的狀態，所以它是接收分片鏈中的特殊“交易”。忽略細節的話，基本上所有 TON 區塊鏈交易都是向接收帳戶（智慧合約）發送一個入站消息。

### 2.4.14	同一智慧合約實例之間的消息。

回想一下，智慧合約可能是本地的（即，像任何普通帳戶一樣駐留在一個分片鏈中）或全域的
（即，在所有分片中具有實例，或者至少在所有分片中具有某個已知深度 d；參見 2.3.18）。

---

14   只有基本工作鏈及其分片鏈才能真正實現上述要求。 其他工作鏈可能提供其他創建消息的方法。
15  作為一個退化的案例，這個分片鏈可能與原始的分片鏈重合 - 例如，如果我們在一個尚未拆分的工作
鏈內工作。

---

如果需要，全域智慧合約的實例可以交換特殊消息以在彼此之間傳遞資訊和價值。 在這種情況下，（不可偽造的）寄件者 $account\_id$ 變得很重要（參見 2.4.4）。

### 2.4.15	發送給智慧合約任何實例的消息；萬用字元地址。

有時，消息（例如，用戶端請求）需要被傳遞到全域智慧合約的所有實例，通常是最接近的
（例如，如果存在與發送者相同的分片鏈中的一個，則它是明顯的候選者）。 一種方法是使用 “萬用字元接收者位址wildcard recipient address”，允許目標 $account\_id$ 的前 d 位元採用任意值。 實際上，通常會將這些 d 位設置為與發送方的 $account\_id$ 中相同的值。

### 2.4.16	輸入佇列不存在。

區塊鏈（通常是分片鏈；有時是主鏈）接收的所有消息——或者基本上由駐留在某個 分片鏈內的 “帳戶鏈account-chain”——立即傳遞（即，由接收帳戶處理）。 因此，沒有 “輸入佇列input queue”。 相反，如果由於區塊總大小和 Gas 使用的限制，並非所有發往特定分片鏈的消息都可以被處理，一些消息只會在原始分片鏈的輸出佇列中堆積。

### 2.4.17	輸出佇列。

從無限分片範例（參見 2.1.2）的角度來看，每個帳戶鏈（即每個帳戶）都有自己的輸出佇列
，包括它已生成但尚未發送給接收者的所有消息。 當然，帳戶鏈只有虛擬存在； 它們被分組為不同的分片鏈，而分片鏈有一個輸出 “佇列queue”，它由屬於分片鏈的所有帳戶的輸出佇列的並集組成。
此分片鏈輸出 “佇列（queue）” 僅對其成員消息強加部分順序。 也就是說，必須在後續塊中生成的任何消息之前提供在前一個區塊中生成的消息，並且必須按照它們生成的順序傳送由同一帳戶生成並具有相同目的地的任何消息。

### 2.4.18	可靠，快速的鏈間消息傳遞。

對於像 TON 這樣的可擴展多區塊鏈項目來說，能夠在不同的分片鏈之間轉發和傳遞消息（參見 2.1.3）至關重要。即使系統中有數百萬消息在傳遞，它們也可以被可靠且快速地傳送（即
，消息不應丟失或傳送不止一次）。 TON 區塊鏈通過結合使用兩個 “消息路由（message routing）” 機制實現了這一目標。

### 2.4.19	超立方體路由（Hypercube routing slow path”。

“慢速路徑

TON 區塊鏈使用 “超立方體路由（Hypercube routing）” 作為一種緩慢但安全可靠的方式，將消息從一個分片鏈傳遞到另一個分片鏈，如有必要，可使用多個中間分片鏈進行傳輸。否則， 任何給定的分片鏈的驗證人都需要追蹤所有其他分片鏈的狀態（輸出佇列），這將需要大量的算力和網路頻寬，因為分片鏈的總量增長，反而限制了系統的可擴展性。因此，無法直接從任何分片向其他分片傳遞消息。相反，每個分片僅 “連接（connected）” 到不同於其$(w,s)$分片識別字的一個十六進位數字的分片（參見 2.1.8）。這樣，所有的分片鏈都構成了一個 “超立方體（hypercube）” 圖形，並且消息沿著這個超立方體的邊緣傳播。

如果將消息發送到與當前分片不同的分片，則當前分片識別字的一個十六進位數字（決定性選擇）將被目標分片的相應數位替換，並且所得到的識別字將通過消息發給最近的目標。16

超立方體路由的主要優點是區塊有效性條件意味著創建分片鏈區塊的驗證人必須收集並處理來自 “相鄰（neighboring）” 分片鏈的輸出佇列的消息，以免丟失它們的抵押。 通過這種方式， 可以預期任何消息遲早會到達其最終目的地； 消息也不能在傳輸過程中丟失或接受兩次。

請注意，超立方體路由引入了一些額外的延遲和費用，因為必須通過幾個中間的分片鏈轉發消息。 然而，這些中間分片鏈的數量增長非常緩慢，如對數鏈 N 的總數的對數 $log N$（更確切的說 [$log_{16} N]-1$）。例如，如果 N≈250，則最多只有一個中間跳； 對於 $N≈4000$ 個 分片鏈， 最多兩個。 通過四個中間躍點，我們可以支援多達一百萬個分片鏈。 我們認為這對於系統的 基本無限可擴展性來說是一個非常小的代價。

### 2.4.20	“快速路徑（fast path）”。

TON 區塊鏈的一個新特點是它引入了一條 “快速路徑”，用於將消息從一個分片鏈轉發到任何其他分片鏈，允許在大多數情況下完全繞過 2.4.19 的 “慢（slow）” 超立方體路由，並將消息傳遞到最後一個目的地分片鏈的下一個區塊。

這個想法如下：在 “慢slow” 超立方體路由期間，消息沿著超立方體的邊緣（在網路中）傳播， 但是在每個中間頂點處被延遲（大約五秒）以在繼續其航行之前被提交到相應的分片鏈中。

為了避免不必要的延遲，可以使用沿超立方體邊緣的合適的 Merkle 證明來中繼消息，而無需等待將其提交到中間的分片鏈中。實際上，網路消息應該從原始分片的 “任務組（task group
）”（參見 2.6.8）的驗證人轉發到目的地 “任務組” 的指定分片區塊生成器（參見 2.6.9）。這可以直接完成，而不需要沿著超立方體的邊緣。當帶有 Merkle 證明的消息到達目的地分片鏈的驗證人（更確切地說，校對人[collators]；參見 2.6.5）時，它們可以立即將其提交到新的區塊中，而無需等待消息完成其沿著 “慢速路徑（slow path）”。然後沿著超立方體邊緣發送回傳送確認以及合適的 Merkle 證據，並且可以通過提交特殊交易來用於沿著 “慢速路徑” 停止消息的行進。

請注意，這種 “即時交付（instant delivery）” 機制並不能取代 2.4.19 中描述的 “慢速”但防止故障的機制。因為驗證人不會因丟失或僅僅決定不將 “快速路徑” 消息提交到其區塊鏈的新區塊而受到懲罰， “慢速路徑”仍被需要17。

因此，兩種消息轉發方法並行運行，只有在將 “快速” 機制的成功證明提交到中間分片鏈時才會中止 “慢速” 機制。18

### 2.4.21	從相鄰分片鏈的輸出佇列收集輸入消息。

當提出用於分片鏈的新區塊時，鄰近的一些輸出消息（如 2.4.19 的路由分支所示）分片鏈作為 “輸入（input）” 消息包含在新塊中並立即傳送（即處理）。 處理這些臨近的輸出消息的順序，會存在一些規則。 基本上來說，必須在任何 “較新（newer）” 消息之前，先傳遞 “較舊（

---

16這不一定是用於計算超立方體路由的下一跳的演算法的最終版本。 特別地，十六進位數位可以由r比特組代替，其中r是可配置參數，不一定等於4。
17 但是，驗證人有一些動機儘快這樣做，因為他們將能夠收集與慢速路徑上尚未消耗的消息相關的所有轉發費用。
18 事實上，人們可能暫時或永久地完全禁用“即時交付”機制，系統將繼續工作，儘管速度較慢。

---

older）” 消息（來自指向較舊主鏈區塊的分片鏈的區塊）； 對於來自相同相鄰分片鏈的消息， 必須遵守 2.4.17 中描述的輸出佇列的部分順序。

### 2.4.22	從輸出佇列中刪除消息。

一旦觀察到輸出佇列消息已經被相鄰的分片鏈傳遞，它就會被特殊交易從輸出佇列中顯式刪除。

### 2.4.23	防止雙重傳遞消息。

為了防止從相鄰分片鏈的輸出佇列中獲取的消息的傳輸兩次，每個分片鏈（更確切地說，其中的每個帳戶鏈）將最近傳遞的消息（或僅僅是它們的雜湊）的集合保存為其狀態的一部分。當觀察到傳遞的消息由其始發的相鄰分片鏈從輸出佇列中刪除時（參見  2.4.22），它也會從最近傳遞的消息的集合中刪除。

### 2.4.24	轉發用於其他分片鏈的消息。

超立方體路由（參見 2.4.19）裡有時出站消息不會傳遞到包含預期接收者的分片鏈，而是傳遞到位於到目的地的超立方體路徑上的相鄰分片鏈。這種情況下，“傳遞（delivery）” 包括將入站消息移動到出站佇列。這在區塊中具體顯示為包含消息本身的特殊轉發事件。從本質上講， 這看起來好像是分片鏈中的某個人收到了消息，並且結果生成了一條相同的消息。

### 2.4.25	為轉發和保留消息支付。

轉發交易實際上花費了一些 gas（取決於轉發的消息的大小），因此將從代表該分片鏈的驗證人轉發的消息的數值中扣除 gas費用。這種轉發支付通常遠小於當消息最終傳遞給其接收者時所支付的 gas 支付，即使該消息由於超立方體路由而被多次轉發。此外，只要消息保存在某個分片鏈的輸出佇列中，它就是分片鏈全域狀態的一部分，因此特殊交易也可以收集長時間保存全域資料的支付。

### 2.4.26	來自主鏈的消息。

消息可以直接從任何分片鏈發送到主鏈，反之亦然。但是，在主鏈中發送消息和處理消息的gas 價格非常高，因此只有在真正需要時才會使用此功能——例如，驗證人可以存入他們的抵押中。在一些情況下，可以定義發送到主鏈的消息的最小抵押（附加值），僅當消息被接收方視為 “有效（valid）” 時才返回。

消息無法通過主鏈自動路由。$workchainid = 1$ 的消息（1 是表示主鏈的特殊 workchainid）無法傳遞給主鏈。

原則上，可以在主鏈內創建消息轉發智慧合約，但使用它的價格會很高。

### 2.4.27	同一個分片鏈中的帳戶之間的消息。

在某些情況下，消息由屬於某個分片鏈的帳戶生成，發往同一個分片鏈中的另一個帳戶。例如
，這發生在一個尚未拆分為多個分片鏈的新工作鏈中，因為負載可控。

此類消息可能會累積在分片鏈的輸出佇列中，然後作為後續塊中的傳入消息進行處理（為此目的，任何分片都被視為臨近分片）。但是，在大多數情況下，可以在原始區塊鏈自身之內傳遞這些消息。

為了實現這一點，將對一個分片鏈區塊中包括的所有交易強加上一個偏序，並且根據這個偏序來處理這些交易（每個交易包括向某個帳戶傳遞消息）。特別是，一項交易可以處理關於這一偏序的一些輸出消息。

在這種情況下，訊息文字不會被複製兩次。相反，始發和處理交易會參考消息的副本。