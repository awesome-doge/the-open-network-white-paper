# 3.2. TON DHT：類似Kademlia的分散式雜湊表

TON分散式雜湊表（DHT）在TON專案的網路部分起著至關重要的作用，用於定位網路中的其他節點。例如，一個想要將交易提交到分片鏈的用戶端可能想要找到該分片鏈的驗證人或校驗者，或者至少某個可能將用戶端的交易中繼到校驗者的節點。這可以通過在TON DHT中查找特殊鍵來完成。TON DHT的另一個重要應用是它可以用來快速填充新節點的相鄰節點列表（參見 3.1.7），只需查找隨機金鑰或新節點的地址即可。如果一個節點對其入站資料包表使用代理和隧道，則它在TON DHT中發佈隧道識別字及其入口點（例如，IP位址和UDP埠）； 緊接著希望將資料包發送到該節點的所有節點將首先從DHT獲得聯繫資訊。
TON DHT是類似Kademlia的分散式雜湊表系列的成員[10]。

### 3.2.1	TON DHT的金鑰。

TON DHT的金鑰是簡單的256位元整數。在大多數情況下，它們被計算為TL序列化物件的SHA256值（參見2.2.5），稱為金鑰的原像或金鑰的描述。在某些情況下，TON網路節點的

抽象位址（參見3.1.1）也可以用作TON DHT的金鑰，因為它們也是256位的，它們也是TL序列化物件的雜湊值。例如，如果節點不害怕公佈其IP位址，任何知道其抽象位址的人都可以找到它，方法是簡單地將該位址作為DHT中的金鑰來查找地址。

### 3.2.2	DHT的值。

分配給這些256位金鑰的值基本上是有限長度的任意位元組字串。這種位元組字串的解釋由相
應金鑰的原像決定；通常通過查找金鑰的節點和存儲金鑰的節點一起才能知道金鑰的值。

### 3.2.3	DHT的節點。半永久性網路身份。

TON DHT的金鑰值映射保留在DHT的節點上——基本上是TON網路的所有成員。為此，除了3.1.1中描述的任何數量的短暫和永久抽象位址之外，TON網路的任何節點（可能除了一些非常輕的節點）至少具有一個 “半永久位址”，也將其標識為TON DHT的成員。這個半永久地址或DHT地址不應該經常更改，否則其他節點將無法找到他們正在尋找的金鑰。如果節點不想顯示其 “真實” 標識，則它會生成一個單獨的抽象位址，僅用於參與DHT。但是，此抽象地址必須是公共的，因為它將與節點的IP位址和埠相關聯。

### 3.2.4	Kademlia距離。

現在我們有256位金鑰和256位（半永久）節點地址。我們在 256 位序列集上引入所謂的XOR
距離或Kademlia距離dK，由下式給出

dK (x, y) := (x ⊕ y)	解釋為一個未簽名的256位元整數	(25)

這裡x⊕y表示相同長度的兩位序列的按位異或（bitwise eXclusive OR）（或 XOR）。Kademlia距離在所有256位元序列的集合2256上引入度量。尤其是，如果當且僅當$x = y, d (x,y) = dK (y, x)$, 以及$dK (x, z) ≤ dK (x, y) + dK (y, z)$時，得出結論$dK(x,y) = 0$。另一個重要特性是在距x 的任何給定距離處只有一個點：$dK (x, y) = dK (x, y′)$ ，暗含了$y = y′$。

### 3.2.5	類似Kademlia的DHTs和TON DHT。

如果期望將Kademlia上的最近節點s的金鑰值K保持為K（即 ，從其地址到K的帶有最小
Kademlia距離最小的s節點。），那麼我們說帶有256位金鑰和256位節點地址的分散式雜湊表
（DHT）是類似Kademlia的 DHT。
這裡是一個小參數，比如當s = 7時提高DHT的可靠性（如果我們只將金鑰保存在一個節點上
——最接近K的那個節點，當那個節點離線時，那個金鑰的值就會丟失）。
根據這個定義，TON DHT是類似Kademlia的DHT。它是通過3.1中描述的ADNL協議實現的。

### 3.2.6	Kademli路由表。

參與Kademlia-like DHT的每個節點通常都維護一個Kademlia路由表。在TON DHT的情況下， 它由n = 256個桶（buckets）組成，編號從0到n-1。第i-th個桶將包含關於一些已知節點的資訊（“最佳” 節點的一個固定數量t，可能還有一些額外的候選人），這些已知節點位於距離節點地址a的Kademli 距離2i到2i+1−1之間33。這個資訊包括它們的（半永久）位址、IP 地址和UDP埠，以及一些可用性資訊，如最後一次ping的時間和延遲。

---

33 如果存儲桶中有足夠多的節點，則可以進一步細分為例如八個子桶，這取決於Kademlia距離的前四位。這會加快DHT查找速度。

---

當Kademlia節點瞭解其他Kademlia節點作為查詢結果時，它將這個查詢結果包含在其路由表的合適桶中，首先作為候選人。然後，如果該桶中的一些 “最佳” 節點失敗（例如，長時間不回應ping查詢），則可以用一些候選人替換它們。通過這種方式，Kademlia路由表保持填充狀態。
來自Kademlia路由表的新節點也包含在3.1.7中描述的ADNL相鄰節點列表中。如果經常使用來自Kademlia路由表的桶中的 “最佳” 節點，那麼從3.1.5中中描述的意義上來說，可以建立一個通道以便於加密資料報表。
TON DHT的一個特殊功能是它嘗試選擇往返延遲最小的節點作為Kademlia路由表的桶的 “最佳” 節點。

### 3.2.7	（Kademlia網路查詢。）Kademlia節點通常支援以下網路查詢：

- PING——檢查節點可用性。
- STORE (key,value)——要求節點將value保持為金鑰key的值。對於TON DHT， STORE查詢稍微複雜一些（參見 3.2.9）。
- FIND_NODE (key,l)——要求節點將Kademlia最近的已知節點l（從其Kademlia路由表）返回到金鑰。
- Find_VALUE (key, l)——與上面相同，但如果節點知道與金鑰key對應的值，則只返回到該值。

當任何節點想要查找金鑰K的值時，它首先創建s'節點的集合S（對於s'的一些小值，比如s'= 5
），S是已知節點中就Kademlia距離而言最接近K的（例如它們來自Kademlia路由表）。然後向它們中的每一個發送Find_Value查詢，並且在它們的答案中提到的節點也包含在S中。如果之前沒有這樣做，那麼來自S的s'節點（最接近於K）也被發送 Find_Value查詢，並且該過程一直持續到找到值或集合S停止增長為止。這是就Kademlia距離而言，距離K最近的節點的一種 “集束搜索（beam search）”。
如果要設置某個金鑰K的值，使用Find_Node查詢而不是Find_Value查詢，則對 s'≥s 運行相同的過程，用來查找距離K最近的節點。之後，STORE查詢發送給所有這些節點。
在實現類似Kademlia的DHT時有一些不太重要的細節（例如，任何節點都應該查找最近的節點s，比如每小時一次，並通過STORE查詢重新發佈所有存儲的金鑰）。我們暫時會忽略它們。

### 3.2.8	啟動Kademlia節點。

當Kademlia節點聯網時，它首先通過查找自己的地址來填充其Kademlia路由表。在此過程中
，它標識出距離自身最近的節點s。它可以從這些節點中下載所有已知的(key,value)對，以填充它的部分DHT。

### 3.2.9	在TON DHT中存儲值。

在TON DHT中存儲值與一般像Kademlia的DHT略有不同。當有人希望存儲一個值時，她必須不僅要向STORE查詢提供金鑰K本身，還要提供其原像——例如TL序列化的字串（開頭帶有幾個預定義的TL構造函數的其中一個），原像包含對字串的 “ 描述 “。稍後由節點保存此金鑰描述以及金鑰和值。
金鑰描述了所存儲物件的 “類型欄位”，其 “所有者” 以及未來更新時的 “更新規則”。所有者通常通過金鑰描述中包含的公開金鑰來標識。如果包含公開金鑰，通常只接受由相應私密金鑰簽名的更新。存儲物件的 “類型欄位” 通常只是一個位元組字串。然而，在某些情況下，它可能更複雜——例如，輸入隧道描述（參見 3.1.6）或節點位址的集合。

“更新規則” 也可以不同。在某些情況下，假使新值由所有者簽名（簽名必須保留為值的一部分
，之後由其他任何節點在獲取金鑰值之後檢查），更新規則只允許用新值替換舊值。在其他情況下，舊值會以某種方式影響新值。例如，它可以包含序號，只有在新序號較大時才會覆蓋舊值（以防止重新操作的攻擊）。

### 3.2.10	TON DHT中的分散式 “流追蹤器”

另一個有趣的情況是，當值包含節點列表時——可能帶有其IP位址和埠，或僅帶有其抽象位址——並且 “更新規則” 在於將請求者包括在此列表中，假使她可以確認她的身份。
該機制可以用於創建分散式 “流追蹤器”，在“流追蹤器”上，對某個 “流”（檔）感興趣的所有
節點可以找到對相同的流感興趣或已經具有副本的其他節點。
TON存儲（參見 4.1.8）使用該技術來查找具有所需檔副本的節點（例如，分片鏈或舊塊的狀態的快照）。但是，更重要的用途是創建 “覆蓋組播子網” 和 “網路興趣小組”（參見 3.3）。這個想法是只有一些節點對特定分片鏈的更新感興趣。如果分片鏈的數量變得非常大，甚至找到對同一分片感興趣的一個節點可能會變得複雜。這種 “分散式流追蹤器” 提供了一種查找這些節點的便捷方法。另一種選擇是從驗證人請求它們，但這不是一種可擴展的方法，驗證人可能選擇不回應來應對任意未知節點的查詢。

### 3.2.11	Fall-back keys

到目前為止所描述的大多數 “金鑰類型”，用它們的TL描述來說具有額外的32位元整數欄位，通常等於零。然而，如果無法從TON DHT中檢索或更新通過雜湊描述獲得的金鑰，則增加該欄位中的值，並進行新的嘗試。以這種方式，通過在受到攻擊的金鑰附近創建許多抽象位址並控制相應的DHT節點，我們不能 “捕獲” 和 “審查” 金鑰（即執行金鑰保留的攻擊）。

### 3.2.12	定位服務。

某些服務位於TON網路中，並通過如3.1中描述的TON ADNL（基於其構建的高級協議）提供
，這些服務可能希望在某處發佈其抽象位址，以便其客戶知道在哪裡找到它們。
然而，在TON區塊鏈中發佈服務的抽象位址可能不是最好的方法，因為抽象位址可能需要經常更改，也因為為了可靠性或負載平衡的目的而提供多個位址是有意義的。
一種替代方法是將公開金鑰發佈到TON區塊鏈中，並使用一個特殊的DHT金鑰，表明公開金鑰作為TL 描述字串中的 “所有者”（參見 2.2.5），用來發佈 服務的抽象位址的最新列表。這是利用Ton服務的方法之一。

### 3.2.13	定位TON區塊鏈帳戶的所有者。

在大多數情況下，TON區塊鏈帳戶的所有者不希望與抽象網路位址相關聯，尤其是 IP 地址， 因為這可能會侵犯他們的隱私。但是，在某些情況下，TON區塊鏈帳戶的所有者可能希望發佈可以聯繫她的一個或多個抽象位址。
典型的情況是TON支付 “閃電網路” 中的節點（參見 5.2），也就是即時加密貨幣轉帳平臺。公共TON支付節點可能不僅希望與其他對等節點建立支付通道，而且還要發佈抽象網路位址， 這個地址可用來在後續沿著已建立的支付通道轉帳支付時聯繫它。
一種選擇是在創建支付通道的智慧合約中包含抽象網路位址。更靈活的選擇是在智慧合約中包含公開金鑰，然後按照 3.2.12 中的說明使用DHT。
最自然的方法是使用控制TON區塊鏈中帳戶的相同私密金鑰，用來簽署和發佈TON DHT中與該帳戶關聯的抽象位址的更新。這幾乎與3.2.12中描述的方式相同；但是，使用的DHT金鑰需要一

個特殊的金鑰描述，這個私密金鑰描述只包含account_id本身，等同於 “account description” 的
SHA256值，該值包含帳戶的公開金鑰。包含在此DHT金鑰值中的簽名也將包含帳戶描述。
通過這種方式，用於定位TON區塊鏈帳戶的一些所有者的抽象網路位址這一機制得以建立。

### 3.2.14	找到抽象地址的位置。

請注意，TON DHT雖然通過TON ADNL實現，但它本身也被TON ADNL用於多種用途。
其中最重要的是從256位抽象位址開始定位節點或其連絡人資料。這是必要的，因為即使沒有提供其他資訊，TON ADNL也應該能夠將資料包表發送到任意的256位抽象地址。
為此，在DHT中將256位抽象位址簡單地作為金鑰被查找。具有該位址的節點（即，使用該位址作為公共半永久DHT位址）被搜索到，在這種情況下，可以知曉其IP位址和埠；或者，可以檢索輸入隧道描述作為所討論的金鑰的值，由正確的私密金鑰簽名，在這種情況下，該隧道描述將用於將ADNL資料包表發送到預期的接收者。
請注意，為了使抽象位址 “public”（可從網路中的任何節點訪問），其所有者必須將其用作半永久性DHT地址，或者發佈（在DHT中，關鍵值等於所考慮的抽象位址）帶有另一個公共抽象位址（例如，半永久位址）的隧道描述輸入，這個公共抽象位址作為隧道的入口點。另一種選擇是簡單地發佈其IP位址和UDP埠。