# 2.1. TON Blockchain作為2-Blockchains的集合及定義

TON Blockchain實際上是區塊鏈的集合（甚至是“區塊鏈中的區塊鏈”的集合，或者說是“二維區塊鏈”（2-blockchains）——這一概念將在後面的 2.1.17 中闡明），因為沒有哪個單一的區塊鏈專案可以實現百萬 TPS 交易輸送量，對比而言，單鏈區塊鏈僅能達到每秒數十次的交易速度。

### 2.1.1	TON 區塊鏈類型列表。包含以下這幾類區塊鏈：

- 獨特的master blockchain，或簡稱主鏈（masterchain），用來存儲一些基礎資訊，這些資訊包括協定、參數的當前價值；驗證人和它們的抵押記錄組；當前活躍的工作鏈（workchains）和它們的 “分片”（shards）組；及最重要的是所有工作鏈（ workchains）和分片鏈（shardchains）裡的最近生成的雜湊值組。
- 多個working blockchains（最多可達 $2^{32}$），或簡稱工作鏈（workchains），是名副其實的“苦力”，功能包含價值交換和智慧合約。不同的工作鏈有不同的“規則”，意味著不同的帳戶位址格式、不同的交易格式，不同的虛擬機器（VMs）用於智慧合約， 甚至是不同的工作鏈由不同的加密貨幣來處理交易等。但它們都必須滿足統一的互通性標準，以便使不同工作鏈之間的交互成為可能且相對簡單。在這點而言， TON Blockchain是異構的（參見 2.8.8），類似於 EOS（參見 2.9.7）和 Polkadot（參見 2.9.8）。
- 每個工作鏈（workchains）又依次被細分為最多 $2^{60}$ 次方個分片鏈（shard blockchains；或簡稱為shardchains），分片鏈與工作鏈的生成規則和區塊結構相同，一個分片鏈負責一種類型的帳戶子集，具體取決於其帳戶位址的頭幾個位元組（這些是最重要的）。換句話說，分片的形式植入系統中的（參見 2.8.12）。因為所有這些分片鏈具有統一的生成規則和區塊結構，這樣說來所以 TON 區塊鏈是同構的（參見 2.8.8），這也與之前乙太坊的的一個擴容方案$^{[2]}$中提及的類似。
- 分片鏈上的每個區塊（其實主鏈上也是）不僅僅只是一個區塊，它可能是一個小型區塊鏈。通常情況下，這種 “區塊的區塊鏈” 或者 “垂直區塊鏈” 都只包含一個塊，然後我們可能會認為這只是分片鏈的相應區塊（在這種情況下也稱為 “水準區塊
鏈”）。但是，如果有必要修復不正確的分片鏈區塊，則會將新區塊提交到 “垂直區塊鏈” 中，其中包含無效 “水準區塊鏈” 區塊的替換品或者 “區塊的不同性”，包含此區塊先前版本部分內容的僅有描述也需要修改。這是一種特定於TON的機制，用於替換檢測到的無效區塊，而不會涉及所有分片鏈的分叉問題；它將在 2.1.17 中更詳細地解釋。現在，我們只是說每個分片鏈（和主鏈）不是傳統的區塊鏈，而是鏈中鏈或區塊鏈中的區塊鏈，或者只是一個二維區塊鏈（2D-blockchain或2-blockchain）。

### 2.1.2	無限分片範式（Infinite Sharding Paradigm）。

幾乎所有的區塊鏈分片提議都是 “自上而下” 的：首先我們想像一個單鏈區塊鏈，然後討論如何將其拆分成幾個交互的分片鏈，以提高性能並實現可擴展性。
TON 的分片方法是 “自下而上”，解釋如下。

想像一下，分片已經發揮到極限，因此每個分片鏈中只保留一個帳戶或智慧合約。然後我們有大量的 “帳戶鏈（account- chains）”，每個帳戶鏈描述唯一一個帳戶的狀態和狀態過渡，並相互發送價值承載資訊以傳輸價值和資訊。

當然，想要擁有數以億計的區塊鏈是不切實際的，並且每個區塊鏈通常很少出現更新（即新區塊）。為了更有效地實現它們，我們將這些 “帳戶鏈（account- chains）” 分組為 “分片鏈（ shardchains）”，以便分片鏈的每個區塊基本上都是已分配給此分片的帳戶鏈區塊的集合。因此，“帳戶鏈” 在 “分片鏈” 中僅以純粹的虛擬或邏輯形式存在。

我們將這種觀點稱為無限分片範式。它解釋了TON區塊鏈的許多設計初衷。

### 2.1.3	消息/即時超立方體路由。

即時超立方體路由（Instant Hypercube Routing）。無限分片範式（Sharding Paradigm）引導我們將每個帳戶（或智慧合約）視為自己的分片鏈。那麼，A帳戶可能影響B帳戶狀態的唯一方法就是向它發送一條消息（這是所謂的Actor模型的特殊實例，帶有Actors帳戶；參見2.4.2）。因此，帳戶之間的消息系統（和分片鏈，因為從一般意義上說來源和目標帳戶通常在不同的分片鏈中）對於可擴展系統至關重要，如TON區塊鏈。實際上，TON區塊鏈的這個新功能，我們稱其為即時超立方體路由（Instant Hypercube Routing；參見 2.4.20），使其能夠將一個分片鏈區塊中創建的消息傳遞和處理至目標分片鏈的下一個區塊中，而不用管系統中分片鏈的總數。

### 2.1.4	主鏈、工作鏈和分片鏈的數量。

TON區塊鏈只有一個主鏈。但該系統最多可容納 $2^{32}$個工作鏈，每個工作鏈最多可細分成 $2^{60}$個分片鏈。

---

[2] [https://github.com/ethereum/wiki/wiki/Sharding-FAQ](https://github.com/ethereum/wiki/wiki/Sharding-FAQ)

---

### 2.1.5	工作鏈可以是虛擬區塊鏈，而不是真正的區塊鏈。

因為工作鏈通常被細分為分片鏈，所以工作鏈的存在是“虛擬的”，而不是真正的區塊鏈，這意味著它不是後文2.2.1所述的一般意義上的真正區塊鏈，而只是一個分片鏈的集合。當只有一個分片鏈對應一個工作鏈時，這個唯一的分片鏈可能可以用工作鏈來識別，在這種情況下，工作鏈成為“真正的”區塊鏈，至少在一段時間內，它與常規的單鏈區塊鏈的設計有一定相似性。然而無限分片範式（參見 2.1.2）告訴我們，這種相似性只是表面：重要的是潛在大量的“帳戶鏈（account- chains）”可以暫時歸類到一個區塊鏈中。

### 2.1.6	工作鏈的識別。

每個工作鏈都有序號或工作鏈的專屬識別字（$workchain_id：uint32$），這是一個無符號的32 位元整數。工作鏈由主鏈中的特殊交易創建，定義（先前未使用過的）工作鏈的識別字和工作鏈的正式描述，至少足以使這個工作鏈與其他工作鏈交互，並對這個工作鏈的區塊進行表面驗證。

### 2.1.7	創建和啟動新的工作鏈。

基本上任何社區成員都可以創建新的工作鏈，只需支付發佈新工作鏈所需的（高）主鏈交易費用，這些費用是用於發佈新工作鏈的正式規範。但為了使新的工作鏈更積極，它需要得到三分之二驗證人的共識，因為他們也需要升級軟體來處理新工作鏈的區塊，並通過主鏈的特殊交易來表明它們已經准好用新的工作鏈了。對啟動新工作鏈感興趣的一方可能會為驗證人提供一些激勵，通過智慧合約分發的一些獎勵來支持新的工作鏈。

### 2.1.8	鑒定分片鏈。

每個 shardchain 由一對（w,s）=（workchain_id,shard_prefix）標識，其中 $workchain_id：
uint$ 標識相應的工作鏈，$shard_prefix：2^{0...60}$是一個長度最多為2的60次方的字串，來定義
32此分片鏈負責的帳戶子集。即，所有具有以 $shard_prefix$ 開頭的 $account_id$ 的帳戶（即
$shard_prefix$ 作為最高有效位）將被分配給該分片鏈。

### 2.1.9	識別帳戶鏈。

回想一下，“帳戶鏈（account- chains）”只是虛擬存在的（參見2.1.2）。但是，它們有一個自然的識別字——即（workchain_id，account_id），因為任何帳戶鏈裡都包含有關狀態資訊和準確的某一帳戶的更新資訊（無論是簡單帳戶還是智慧合約，區別並不重要）。

### 2.1.10	分片鏈的動態拆分和合併（參照2.7）。

不那麼複雜的系統可以使用靜態分片——例如，通過使用 account_id 的前八位來選擇 256 個
預定義分片中的一個。
TON區塊鏈的一個重要特徵是它實現了動態分片，這意味著分片數量不固定。相反，如果滿足某些條件（實際上，如果原始分片上交易負荷負載在很長一段時間內足夠高的話），則分片$shard (w, s)$ 可以自動細分為分片$shards (w, s.0)$ 和$(w, s.1)$ 。反過來如果負載在一段時間內都很低，則分片$shards (w, s.0)$ 和$(w, s.1)$ 可以自動合併並退回$shard (w, s)$ 。
最初，只為工作鏈 w 創建了一個分片$shard (w, ∅)$ 。之後，如果有必要，它會細分為更多分片
（參見2.7.6和2.7.8）。

### 2.1.11	基礎工作鏈或初始工作鏈（Workchain Zero）。

雖然使用特定的規則和交易可以定義多達$2^{32}$條工作鏈，但我們最初只定義了一條工作鏈， workchain_id = 0。這個稱為基礎工作鏈或初始工作鏈（Workchain Zero），它是用於處理TON智慧合約和轉移TON coins的工作鏈，也稱為Grams（參照附錄a）。大多數應用程式只需要初始工作鏈。基礎工作鏈的分片鏈將被稱為基礎分片鏈（basic shardchains）。

### 2.1.12	出塊時間。

我們期望每五秒在每個分片鏈和主鏈上生成一個新區塊。這可以將交易確認時間縮到非常短。所有分片鏈的新區塊幾乎同時生成；而主鏈將在大約一秒後生成一個區塊，因為它包含所有 分片鏈的最新區塊的雜湊值。

### 2.1.13	通過主鏈使工作鏈和分片鏈緊密耦合。

一旦分片鏈生成的某個區塊的雜湊值被合併到主鏈的某個區塊中，這個分片鏈區塊和它的父塊都會被認為是 “經典的”，這意味著之後所有分片鏈出的區塊都可以引用它們，因為它們是固定且不可更改的。實際上，每個新的分片鏈區塊都包含最新主鏈區塊的雜湊值，並且引用自主鏈區塊的所有分片鏈區塊被視為新區塊，且不可變。

也就是說，這意味著在分片連區塊中提交的交易或消息可以安全用於其他分片鏈的下一系列區塊中，且無需等待。比如基於前一筆交易，你在發送消息或採取其他行動之前，需要系統的20 個確認（即在同一區塊鏈中原始區塊之後生成的 20 個區塊），這在大多數 “鬆散耦合” 系統（參見 2.8.14）裡是常見的，例如 EOS。但是在我們的 “緊密耦合” 系統中，你提交後僅僅5秒就後能在其他分片鏈中發送交易和消息，這種能力是我們相信它的原因，這也是第一個能提供這種前所未有性能的系統（參見 2.8.12 和 2.8.14）。

### 2.1.14	主鏈（Masterchain）區塊的雜湊作為一個全域狀態（global state）。

根據 2.1.13，整體來看，最後一個主鏈區塊的雜湊值確定了系統的全域狀態。 而無需分別監視其他 shardchains 的狀態。

### 2.1.15	驗證人（Validators）生成新區塊；參照 2.6。

TON區塊鏈使用 Proof-of-Stake（PoS）在分片鏈和主鏈中生成新區塊。這意味著會存在幾百個驗證人——那些已經進行存幣（大量的TON coins）質押的特殊節點，通過一個特殊的主鏈交易才有資格成為驗證人並生成新區塊。

然後，以確定的偽隨機方式將小量子集驗證人分配給每個分片$shard (w; s)$ ，大約每 1024 個區塊改變一次。這些子集驗證人通過從用戶端收集合適的擬議中交易給新的有效候選區塊，會提出建議並就下一個分片區塊的內容達成共識。對於每個區塊，驗證人都存在偽隨機選擇的順序，以確定每一輪中誰的候選區塊享有最高出塊優先順序。

驗證人和其他節點會檢驗被提名的候選區塊的有效性；如果驗證人簽署了無效性，則會受到自動懲罰，丟失部分或全部的質押代幣，或者在一段時間內不許繼續做驗證人。在此之後，驗證人應該就下一個區塊的選擇達成共識，主要通過 BFT共識協議（拜占庭容錯；參見 2.8.4）的有效變體，類似於pBFT【4】或者Honey Badger BFT【11】。如果達成共識，則創建新區塊
，驗證人會瓜分該塊的交易費用和新造代幣（挖礦）獎勵。

每個驗證人可以選擇參與幾個驗證人子集；這種情況下，所有驗證和共識演算法都會同時運行。在所有新的分片鏈生成區塊或出塊超時後，一個主鏈區塊將會生成，它包括所有分片鏈最新區塊的雜湊值。這是由驗證人通過BFT共識完成的。3

有關TON PoS的方法及其經濟模型的更多詳細資訊，請參見第 2.6 節。

### 2.1.16	主鏈（masterchain）分叉。

我們採用緊密耦合導致的複雜性是，轉換到主鏈的一個不同分叉幾乎必然要求在一些分片鏈上轉換到另一分叉。另一方面，只要主鏈中沒有分叉，分片鏈就不可能分叉，因為分片鏈區塊的雜湊值都是合併到主鏈區塊中，分片鏈的備用分叉中沒有區塊能夠成為“經典”。

一般規則是，如果主鏈區塊B'是區塊B的上一個區塊，則區塊B'包含分片鏈(w; s)的區塊B’w;s的雜湊值Hash (B’w;s)，且區塊B包括雜湊值Hash (Bw;s)，那麼區塊B’w;s也是區塊Bw;s的上一個區塊。否則，主鏈區塊B無效。

我們預計主鏈幾乎不會分叉，因為TON區塊鏈採用的BFT共識下，只有在大多數驗證人行為不正確的情況下才可能發生這種情況（參見2.6.1和2.6.15），這將意味著違法者會遭受重大損 失。因此可以說，分片鏈中不會有真正的分叉。相反，如果檢測到無效的分片鏈，它會通過2-blockchain的“垂直區塊鏈”機制（參見2.1.17）進行糾正就可以實現這一目標，而無需分叉
“水準區塊鏈”（horizontal blockchain，即分片鏈）。同樣的機制也可用於修復主鏈區塊中的非致命錯誤。

### 2.1.17	更正無效的分片鏈區塊。

通常情況下，只有有效的分片鏈區塊才能出塊，因為分配到分片鏈的驗證人必須有三分之二達到拜占庭共識，新區塊才能出塊。然而，系統必須先允許檢測之前已經出的無效區塊並校正。

當然，一旦找到無效的分片鏈區塊——由驗證人（不一定是負責這個分片鏈的）或 “漁夫”（ fisherman）；系統內的一種節點，可以存入一定代幣然後提出有關區塊有效性的問題；參見2.6.4）——當無效性的聲明及其證據被提交到主鏈時，簽署區塊無效性的驗證人將收到懲罰
——失去部分質押和/或暫時從驗證人陣營中退出（後一種措施面對攻擊者竊取其他良性驗證
人的簽名私密金鑰這種情況時很重要）。

然而這還不夠，因為系統（TON Blockchain）的整體狀態由於先前釋放的分片鏈區塊無效而被證明是無效的。必須使用較新的有效區塊替換此無效塊。

大多數系統都會 “回退” 至分片鏈無效區塊的前一個區塊來實現此目的，再之前的其他區塊不受其他每個分片鏈中的無效區塊傳播的消息影響。並從這些區塊開始分叉。這種方法的缺點是許多其他正確的和已提交的交易突然回退，並且不清楚這些回退的交易是否稍後將被包括在 內。

TON區塊鏈通過使每個分片鏈和主鏈（即“水準區塊鏈”[horizontal blockchains]）的每個 “區
塊” 自身成為一個社區塊鏈（即“垂直區塊鏈”[vertical blockchain]）來解決這個問題，包含不同

3 實際上，三分之二的驗證人就足以達成共識，但盡可能多的簽名是更好的。

版本的 “區塊” 或它們的 “差異””。通常，垂直區塊鏈只包含一個區塊，而分片鏈看起來像一個經典的區塊鏈。然而，一旦確認塊的無效性並將其提交到主鏈區塊中，則允許無效區塊的 “垂直區塊鏈” 在垂直方向上由新區塊增長，從而替換或編輯無效區塊。新區塊由相關分片鏈的當前驗證人子集來生成。

新的 “垂直” 區塊規則的有效性非常嚴格。特別是如果無效區塊中包含著一個虛擬的 “帳戶鏈區
塊”（參見 2.1.2）本身有效，則必須保持新的垂直塊不變。

一旦在無效區塊之上提交了一個新的“垂直”區塊，其雜湊值就會發佈在新的主鏈區塊中（或者說在一個新的“垂直”區塊中，該區塊位於原始主鏈區塊上方，原始主鏈區塊是最初用來發佈無效的分片鏈區塊雜湊值的地方），這些改變進一步擴散到任何的分片鏈區塊中，這些分片鏈區塊引用該無效區塊的先前版本（例如，那些已從不正確的區塊接收消息的區塊）。這一問題的解決方式是通過在垂直區塊鏈中，為以前引用 “不正確” 區塊的所有區塊提交新的 “垂直” 區塊
；新的垂直區塊將引用最新（已更正）的版本。同樣，嚴格的規則禁止更改未受影響的帳戶鏈
（例如依舊像先前版本那樣照常接收資訊）。通過這種方式，修復不正確的區塊會產生 “連帶效應”，最終傳播到所有受影響的分片鏈的最新區塊；這些變化反映在新的 “垂直”主鏈區塊也是如此。

一旦 “歷史重寫” 的波及最新的區塊，新的分片鏈區塊僅在一個版本中生成，僅作為最新區塊版本的接續。這意味著它們將從一開始就包含對正確（最近）垂直區塊的引用。

主鏈狀態隱含地定義了將每個 “垂直” 區塊鏈的第一個區塊的雜湊值轉換為其最新版本雜湊值的映射。這使客戶能夠通過第一個（通常是唯一的）區塊雜湊值來驗證和定位任何 “垂直區塊鏈” 。

### 2.1.18	TON coins和多貨幣工作鏈（multi-currency workchains）。

TON區塊鏈最多支持 $2^{32}$ 種不同的“加密貨幣（cryptocurrencies）”、 “幣（coins）”, 或者 “代幣
（tokens）”，由 32 個位元組的$currency_id$作為區分。可以通過主鏈中的特殊交易添加新的加密貨幣。每個工作鏈都有一個基礎的加密貨幣，並且可以有幾個額外的加密貨幣。

有一種特殊的加密貨幣，$currency_id = 0$，叫作TON coin，也被稱為Gram（參見 附錄A） 。它是初始工作鏈（Workchain Zero）的基礎加密貨幣。它還用作交易費和驗證人的抵押資
產。

原則上，其他工作鏈可能會收取其他代幣作為交易費用。這種情況下，應該提供一些智慧合約
，將這些交易費用自動轉換為Grams。

### 2.1.19	消息的傳遞與價值轉移。

屬於相同或不同工作鏈的分片鏈可以相互發送消息。雖然允許的消息格式取決於接收工作鏈和接收帳戶（智慧合約），但有一些共同的欄位讓工作鏈間消息傳遞成為可能。特別是每個事件可以附加一些價值，價值的形式是一定數量的Grams（TON coin）和/或其他已註冊的加密貨幣，倘若這些已註冊的加密貨幣是被接收工作鏈聲明為可接受的加密貨幣。
這種消息傳遞的最簡單形式是從一個（通常不是智慧合約）帳戶到另一個帳戶的價值轉移。

### 2.1.20	TON虛擬機器。

TON虛擬機器（也稱為TON VM或TVM）是用於在主鏈和基礎工作鏈中執行智慧合約代碼的虛
擬機。其他工作鏈可以同時使用其他虛擬機器或者用其他虛擬機器代替TVM。 在這裡我們列出了它的一些功能。它們將在 2.3.12、2.3.14 中進一步討論。

- TVM將所有資料表示為（TVM）單元（cell）的集合（參見 2.3.14）。每個單元最多包含128位元組的資料，最多包含 4 次對其他單元的引用。由於 “一切都是一組單元” 的理念（參見 2.5.14），這使得TVM能夠處理與TON區塊鏈相關的所有資料，如有必要，包括區塊和區塊鏈全域狀態。
- TVM可以處理任意代數資料類型的值（參見 2.3.12），以TVM細胞裡的Merkle樹或DAG為代表。但它只對單元有效，對代數資料類型未知。
- TVM內置了對雜湊圖的支持（參見 2.3.7）。
- TVM是一台堆疊機器。它的堆疊保持著64 位元整數或對單元的引用。
- 支持64位、128位和256位算術。所有n位算數運算有三種形式：不帶正負號的整數、有符號整數和模數2n整數（後一種情況下不進行自動溢出檢測）。
- TVM具有從n位元到m位元的無符號和有符號整數轉換，對於所有0≤m，n≤256，帶有溢出檢查。
- 預設情況下，所有算數運算都執行溢出檢查，大大簡化了智慧合約的開發。
- TVM具有 “先乘法後位移運算” 和“先位移後除法運算” 的算數運算方式，其中間值以
較大的整數類型計算；這簡化了實現定點算術的過程。
- TVM支援二進位字元串和位元組字串。
- 支援對一些預定義曲線（包括Curve25519）的256位元橢圓曲線加密演算法（ECC）。
- 還存在對某些橢圓曲線上的Weil配對的支持，這有利於快速實現zk-SNARK。
- 支援流行的雜湊函數，包括SHA256。
- TVM可以使用Merkle證明（參見 5.1.9）。
- TVM為 “大型” 或 “全域” 的智慧合約提供支援。這種智慧合約必須意識到分片技術
（參見 2.3.18 和 2.3.16）。而本地智慧合約不用知道是否分片。
- TVM支持閉包。
- 可在TVM內輕鬆實現STG（spineless tagless G-machine）【13】。
除了 “TVM元件” 之外，還可以為TVM設計幾種高階語言。所有這些語言都將具有靜態類型， 並將支援代數資料類型。我們設想了以下可能性：
- 類似 Java 的命令式語言，每個智慧合約類似於一個單獨的類別。
- 一種惰性的函數式語言（設想一下Haskell）。
- 熱切的功能語言（設想一下ML）。

### 2.1.21	可配置的參數。

TON區塊鏈 的一個重要特徵是它的許多參數都是可配置的。這意味著它們是主鏈狀態的一部分，並且可以通過主鏈中的某些特殊提案/投票/結果交易記錄進行更改，而無需任何硬分叉。改變這些參數需要收集三分之二的驗證人投票，以及所有其他參與投票過程中支持該提案的參與者的一半以上的投票。