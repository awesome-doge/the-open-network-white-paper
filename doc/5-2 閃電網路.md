# 5.2. 閃電網路

現在我們討論 TON Payments 的“閃電網路”，它可以實現任意兩個參與節點間的即時轉帳。

### 5.2.1 支付通道的限制

支付通道對於期望在他們之間進行大量轉帳的各方非常有用。但是如果只需向特定收款方轉帳一次或兩次，那麼與她創建支付通道將是不切實際的。除此之外，這意味著凍結支付通道中的大量資金，並且無論如何都需要至少兩個區塊鏈交易。

### 5.2.2	支付通道 或 “閃電網路”

支付通道網路通過支付通道鏈實現轉帳，克服了支付通道的缺陷。如果 A 希望將資金轉移到E，她不需要與 E 建立支付通道。通過幾個中間節點（例如，四個支付通道，從 A 到 B，從 B 到 C，從 C 到 D，從 D 到 E）連接 A 和 E 的支付通道就足夠了。.

### 5.2.3 支付通道網路概述

回想一下，支付通道網路，也稱為 “閃電網路”，由一組參與節點組成，其中一些節點已在它們之間建立了長期支付通道。我們將看到這些支付通道必須是 5.1.7 意義上的“智慧”。 當參與節點 A 想要將錢轉移到任何其他參與節點 E 時，她試圖找到在支付通道網路內連接 A 到 E 的路徑。當找到這樣的路徑時，她沿著這條路徑進行 “區塊鏈資金轉帳”。

### 5.2.4 區塊鏈資金轉帳

假設存在從 A 到 B，從 B 到 C，從 C 到 D，從 D 到 E 的支付通道鏈。此外，假設 A 想要將
x 個代幣轉移到 E。

一種簡單的方法是沿著現有的支付通道將 x 個代幣轉移到 B，並要求他將錢進一步轉發給 C。但是，為什麼 B  不自己拿錢呢？因此，必須採用更複雜的方法，無需要求所有相關方相互信任。

這可以通過以下方式實現。A 生成一個大的亂數 u 並計算其雜湊 v = Hash（u）。然後她創建一個授權，如果有一個帶有雜湊 v 的數字 u（參見 5.1.7），在她的支付通道中有 B，則向B 支付 x個代幣。這個授權包含 v，但不是 u，u仍然保密。
之後，B 在其支付通道中創建了與 C 類似的授權。他並不害怕給出這樣的授權，因為他知道A 給他的類似授權的存在。如果 C 曾提出雜湊問題的解決方案來收取 B 承諾的 x 個代幣，那麼 B 將立即向 A 提出該方案，向 A 收取 x 個代幣。

然後創建 C 到 D 和 D 到 E 的類似授權。當授權全部到位時，A 通過將解決方案 u 傳達給所有相關方——或者只是向 E 傳達來觸發轉帳。
本文檔省略了一些細節。例如，這些授權必須具有不同的到期時間，並且授權的金額可能在鏈上略有不同（B 可能只承諾 x——ε個代幣給 C，其中ε是預先商定的小額轉帳費用）。我們暫時忽略這些細節，因為它們對於理解支付通道如何運作以及如何在 TON 中實施這些細節並不太重要。

### 5.2.5 支付通道鏈中的虛擬支付通道

現在假設 A 和 E 期望相互間有很多的支付往來。他們可能會在他們之間的區塊鏈中創建一個新的支付通道，但這仍然非常昂貴，因為有些資金會被鎖定在這個支付通道中。另一種選擇是對每筆付款使用 5.2.4 中描述的區塊鏈資金轉帳。但是，這將涉及大量網路活動以及所涉及的所有支付通道的虛擬區塊鏈中的大量交易。
另一種方法是在支付通道網路中連接 A 到 E 的鏈內創建虛擬支付通道。為此，A 和 E 為他們的付款創建（虛擬）區塊鏈，就像他們要在區塊鏈中創建支付通道一樣。然而，他們不是在區塊鏈中創建支付通道智慧合約，而是要求所有中間支付通道——連接 A 到 B、B 到 C等等通道——在中間創建簡單的支付通道，綁定到 A 和E創建的虛擬區塊鏈（參見 5.1.10）。換句話說，現在根據 A 和 E 之間的最終結算轉移資金的授權存在於每個中間支付通道內。
如果虛擬支付通道是單向的，那麼這種授權可以很容易實現，因為最終的不平衡δ將是負數， 因此可以在中間支付通道內以與 5.2.4 中描述的相同的順序創建簡單的支付通道。它們的到期時間也可以以相同的方式設置。
如果虛擬支付通道是雙向的，情況會稍微複雜一些。在這種情況下，應該根據最終結算將轉移δ代幣的授權分為兩個半授權，如 5.1.10 所述：向前方向轉移δ− = max(0, −δ) 代幣，以及在向後方向上傳遞δ+ = max(0, δ) 。這些半授權可以在中間支付通道中獨立創建，一個從 A 到 E方向的半授權鏈，另一個相反方向的鏈。

### 5.2.6 尋找閃電網路中的路徑

到目前為止，有一點仍然未被討論：A 和 E 將如何在支付網路中找到連接它們的路徑？如果支付網路不是太大，則可以使用類似 OSPF 的協定：支付網路的所有節點創建覆蓋網路（參見 3.3.17），然後每個節點傳播所有可用連接（即，參與支付通道）通過gossip協議向其鄰近節點提供資訊。最終，所有節點都將擁有參與支付網路的所有支付通道的完整列表，並且能夠自己找到最短路徑——例如，通過應用 Dijkstra 修改的演算法版本來考慮所涉及的支付通道的
“容量”（即，可以沿通道轉移的最大金額）。一旦找到候選路徑，就可以通過包含完整路徑的特殊 ADNL 資料包進行探測，並要求每個中間節點確認所討論的支付通道的存在，並根據該路徑進一步轉發該資料包。之後，可以構建鏈，以及用於鏈轉移或者在支付通道鏈中（參見5.2.4）創建虛擬支付通道的協議可以運行。

### 5.2.7 優化

可以在此處進行一些優化。例如，只有閃電網路的傳輸節點需要參與 5.2.6 中討論的類似
OSPF 的協議。希望通過閃電網路連接的兩個“葉子”節點將彼此通信他們所連接的傳輸節點的

清單（即，他們已經建立了參與支付網路的支付通道）。然後，如上面 5.2.6 中所述，可以檢查從一個列表到另一個清單中的傳輸節點的路徑。

### 5.2.8 結論

我們已經概述了TON項目的區塊鏈和網路技術如何足夠完成創建TON Payments（一個用於鏈下即時轉帳和小額支付的平臺）的任務。該平臺對於TON生態系統中的服務非常有用，使他們可以在有需要時輕鬆收取小額支付。

我們提出了一種可擴展的多區參見鏈架構，能夠支持大規模流行的加密貨幣和去中心化應用程式，帶有使用者友好的介面。
為了實現必要的可擴展性，我們提出了TON區塊鏈，一個“緊密耦合”的多區塊鏈系統（參2.8.14），採用自下而上的分片方法（參見2.8.12和2.1.2）。為了進一步提高潛在績效，我們引入了二維區塊鏈（2-blockchain）機制來替換無效區塊（參見2.1.17）和即時超立方體路由
（Instant Hypercube Routing），以實現分片之間更快速的交流（參見2.4.20）。將TON區塊鏈與現有和計畫中的區塊鏈專案（參見2.8和2.9）進行簡要比較，突出了TON這種方法的好處
，這是一個追求每秒處理數百萬次交易的系統。
第3章中描述的TON網路，涵蓋了計畫的多區塊鏈基礎設施的網路需求。該網路元件還可以與區塊鏈結合使用，以創建廣泛的應用和服務，單獨使用區塊鏈是不可能的（參見2.9.13）。第4章討論的這些服務包括TON DNS，這是一種將人類可讀物件識別碼轉換為其位址的服務; TON Storage，一個用於存儲任意檔的分散式平臺; TON Proxy，一種將網路訪問匿名化和訪問TON驅動服務的服務;TON Payments（參見第5章），一個跨TON生態系統、用於即時脫鏈資金轉移的平臺，應用程式可以使用這個生態系統進行小額支付。
TON基礎設施可以使用專門的輕用戶端錢包和“ton流覽器”的桌面和智慧手機app，為終端使用者提供類似流覽器的體驗（參見4.3.24），這使得在TON平臺上進行的加密貨幣支付、與智慧合約和其他服務的交互對大眾使用者可訪問。這樣的輕用戶端可以集成到Telegram Messenger用戶端（參見4.3.19），從而最終為數億用戶帶來了大量基於區塊鏈的應用程式。