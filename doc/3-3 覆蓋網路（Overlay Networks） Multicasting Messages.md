# 3.3. 覆蓋網路（Overlay Networks） Multicasting Messages

在像TON區塊鏈這樣的多鏈系統中，甚至完整節點通常也只對獲取某些分片鏈的更新（即新區塊）感興趣。為此，必須在TON網路內部建立一個特殊的覆蓋（子）網路，位於3.1 中討論的ADNL協議之上，每個分片鏈都有一個。
因此，構建對任意覆蓋子網的需求在增加，構建任意覆蓋子網對任何願意參與的節點都開放。基於ADNL的特殊gossip協定將在這些覆蓋網路中運行。特別是，這些gossip協議可用於在這種子網內傳播（廣播）任意資料。

### 3.3.1	覆蓋網路。

覆蓋（子）網路簡單地是在一些較大網路內實現的（虛擬）網路。 通常，只有較大網路的一些節點參與覆蓋子網，並且這些節點之間只有一些 “links” ，不管是實體的還是虛擬的，才是覆蓋子網的一部分。
通過這種方式，如果包含網路被表示為圖形（在資料包表網路的情況下可以使用完整的圖形， 例如 ADNL，這樣任何節點都可以輕鬆地與任何其他節點通信），覆蓋子網路是這個圖形的子圖。
在大多數情況下，覆蓋網路使用基於較大網路的網路通訊協定構建的一些協議來實現。它可以使用與較大網路相同的位址，或使用自訂位址。

### 3.3.2	TON中的覆蓋網路。

TON中的覆蓋網路建立在3.1中討論的ADNL協議之上；它們也使用256位ADNL抽象位址作為
覆蓋網路中的位址。每個節點通常選擇它的一個抽象位址加倍作為在覆蓋網路中的位址。
與ADNL相比，TON覆蓋網路通常不支援將資料包表發送到任意其他節點。相反，在一些節點之間建立一些 “半永久連結”（相對於所考慮的覆蓋網路稱為 “相鄰節點”），並且消息通常沿著這些連結（即從一個節點到其中一個相鄰節點）被轉發。以這種方式，TON覆蓋網路是ADNL 網路的（完整）圖形內的（非完整）子圖。

可以使用專用的對等ADNL通道來實現與TON覆蓋網路中的相鄰節點的連結（參見 3.1.5）。覆蓋網路的每個節點維護一份相鄰節點的清單（與覆蓋網路有關），包含它們的抽象位址（用於在覆蓋網路中識別它們）和一些連結資料（例如，用於與它們通信的ADNL通道）。

### 3.3.3	私人和公共覆蓋網路。

一些覆蓋網路是公共的，這意味著任何節點都可以隨意加入它們。其他是私有的，意味著只允許某些節點被接納（例如，那些可以證明其身份為驗證人的節點）。一些私有覆蓋網路甚至可以為 “general public” 所知。這種覆蓋網路的資訊僅對某些可信節點可用；例如，它可以使用公開金鑰加密，並且只有具有相應私密金鑰副本的節點才能解密此資訊。

### 3.3.4	中心化控制的覆蓋網路。

一些覆蓋網路是中心化控制的，由一個或多個節點控制，或由一些廣為人知的公開金鑰所有者控制。其他的是去中心化的，這意味著沒有特定的節點負責它們。

### 3.3.5	加入覆蓋網路。

當一個節點想要加入一個覆蓋網路時，它首先必須知道它的256位元網路識別字，通常等於覆蓋網路描述的SHA256——這是一個序列化物件的TL語言（參見2.2.5），它可能包含例如，覆蓋網路的中心權威（即其公開金鑰，可能是抽象地址34）；具有覆蓋網路名稱的字串；如果這是與分片相關的覆蓋網路，也可以是TON 區塊鏈分片識別字，等等。
有時可以從網路識別字開始恢復覆蓋網路描述，只需在TON DHT中查找即可。在其他情況下
（例如，對於私有覆蓋網路），我們必須獲得網路描述以及網路識別字。

### 3.3.6	找到覆蓋網路的一個成員的位置。

在節點獲知其想要加入的覆蓋網路的網路識別字和網路描述之後，它必須至少找到屬於該網路的一個節點。
對於不想加入覆蓋網路但只想與之通信的節點，也需要這樣做；例如，可能存在專用於收集和傳播特定分片鏈的交易候選人的覆蓋網路，並且用戶端可能想要連接到該網路的任何節點以建議建議。
用於定位覆蓋網路的成員的方法在該網路的描述中定義。有時（特別是對於私人網路絡），我們必須已經知道能夠加入的成員節點。在其他情況下，一些節點的抽象位址包含在網路描述中。更靈活的方法是在網路描述中僅指示負責網路的中心機構，然後通過由該中央機構簽名的某些DHT金鑰的值來獲得抽象地址。
最後，真正去中心化的公共覆蓋網路可以使用3.2.10中描述的 “分散式流追蹤器” 機制，也可以在TON DHT的幫助下實現。

### 3.3.7	找到覆蓋網路的更多成員。創建連結。

一旦找到了覆蓋網路的一個節點，可以向該節點發送一個特殊的查詢，要求提供其他成員的列表，例如，被查詢節點的相鄰節點，或者隨機選擇其中一個節點。
這使得加入成員能夠通過選擇一些新知曉的網路節點並建立到它們的連結（例如3.3.2中概述的專用ADNL點對點通道）來填充關於覆蓋網路的 “鄰接（adjacency）” 或 “相鄰節點列表（ neighbor list）”。之後，將向所有相鄰節點發送特殊消息，表明新成員已準備好在覆蓋網路中工作。相鄰節點包含它們在相鄰節點清單中的新成員的連結。

---

34 或者，如3.2.12中所述的那樣，抽象位址可以存儲在DHT中。

---

### 3.3.8	維護相鄰節點列表。

覆蓋網路節點必須時不時更新它的相鄰節點列表。一些相鄰節點，或者至少是它們的連結（通道）可能會停止回應；在這種情況下，必須將這些連結標記為 “暫停（suspended）”，必須做一些重新連接到此類相鄰節點的嘗試，並且如果這些嘗試失敗，則必須銷毀連結。
另一方面，每個節點有時會從隨機選擇的相鄰節點請求它的相鄰節點清單（或做部分隨機選 擇），方法是通過向它添加一些新發現的節點，並刪除一些舊節點，這個過程可以是隨機的， 也可以取決於它們的回應時間和資料包丟失統計資訊。

### 3.3.9	覆蓋網路是一個隨機子圖。

通過這種方式，覆蓋網路是ADNL網路裡的隨機子圖。如果每個頂點的度數至少為3（例如， 如果每個節點連接到至少三個相鄰節點），則該隨機圖會以幾乎為1的概率這種大家都知道的方式連接。更準確地說，帶有n個頂點隨機圖的斷鏈的概率是極小的，如果n ≥ 20，則可以完全忽略這個概率（當然，當不同分片間的節點沒有機會互相瞭解時，這不適用於全域網路磁碟分割的情況）。在另一方面，如果 n 小於 20，就足以要求每個頂點有例如至少十個相鄰節點。

### 3.3.10	TON覆蓋網路經過優化，可降低延遲。

TON覆蓋網路優化了由下述之前的方法生成的 “隨機” 網路圖。每個節點都嘗試保留至少三個帶有最小往返時間的相鄰節點，並很少改變這個 “快相鄰節點” 的列表。同時，它還至少有三個完全隨機選擇的 “慢相鄰節點”，因此覆蓋網路圖總是包含一個隨機子圖。這是保持連線性並防止將覆蓋網路分成幾個未連接的區域子網所必需的。至少三個帶有中間往返時間的“中間相鄰節點”也會被選擇和保留，它們受限於一定的常數（實際上是快相鄰節點和慢相鄰節點的往返時間的一種函數）。
通過這種方式，覆蓋網路的圖形仍然保持足夠的隨機性用來連接，但是對降低延遲性和提高輸送量做了優化。

### 3.3.11	覆蓋網路中的gossip協定。

覆蓋網路習慣於運行所謂的一種gossip協定，同時讓每個節點僅與其相鄰節點交互，gossip協定得以實現一些全域目標。例如，有一些gossip協議用來構建一個大致清單，這個清單包括
（不是很大的）的覆蓋網路的所有成員，或者用來計算一個（任意大的）覆蓋網路成員的大概數，在每個節點上只使用有限的記憶體量（細節參見 [15, 4.4.3] or [1]）。

### 3.3.12	覆蓋網路作為廣播域。

在覆蓋網路中運行的最重要的gossip協定是廣播協定（broadcast protocol），旨在將廣播消息傳播給所有其他節點，這些廣播消息由網路的任何節點或者可能是指定的發送方的一個節點生成。
實際上有幾種廣播協議，針對不同的用例進行了優化。最簡單的一種是接收新廣播消息並將它們中繼到所有相鄰節點，這些相鄰節點還沒有獨立發送該消息副本過。

### 3.3.13	更複雜的廣播協議。

某些應用可能需要更複雜的廣播協定。例如對於發送量級比較大的廣播消息，向相鄰節點發送不是新接收的消息本身，而是發送其雜湊（或新消息的雜湊集合）是合乎情理的。在知道了先

前看不見的消息的雜湊之後，相鄰節點可以自己請求消息，例如使用3.1.9中討論的可靠的大資料包表協議（RLDP）進行傳輸。這樣，新消息將僅從一個相鄰節點中下載。

### 3.3.14	檢查覆蓋網路的連線性。

如果存在一個已知節點（例如覆蓋網路的 “所有者” 或 “創造者”）必須在這個覆蓋網路中，那麼這個覆蓋網路的連線性可以被檢查。然後，所討論的節點時不時地廣播包含當前時間、序號及其簽名的短消息。任何其他節點可以確定它仍然連接到覆蓋網路，如果它不久前已經收到這樣的廣播。該協議可以擴展到幾個眾所周知的節點的用例；例如它們都將發送此類廣播，並且所有其他節點都想要從超過一半的眾所周知的節點接收廣播。
在用於傳播特定分片鏈的新區塊（或僅新區塊頭）的覆蓋網路這一例子中，節點用來檢查連接線的一個好方法是追蹤截至目前接收的最新區塊。因為區塊通常每五秒生成一次，如果說超過30秒都沒有收到新區塊，則該節點可能已經與覆蓋網路斷開連接。

### 3.3.15	流媒體廣播協議。

最後，還有一個用於TON覆蓋網路的流媒體廣播協議，例如用於在某些分片鏈（“shardchain 任務組”）的驗證人中宣傳候選區塊，當然驗證人也會為此目的創建一個私有覆蓋網路。可以使用相同的協定將新的分片鏈區塊傳播到該分片鏈的所有完整節點。
該協議已在2.6.10中概述：新的（大）廣播消息被分成例如N個一千位元組的塊；通過諸如Reed-Solomon或噴泉碼（例如，RaptorQ代碼 [9] [14]）之類的糾刪碼將這些塊的序列增加到M ≥ N的塊，並且這些M塊被資料流到所有相鄰節點，按區塊編號昇冪排列。參與的節點收集這些塊直到它們可以恢復原始的大消息（為此一個節點必須成功接收至少N個區塊），然後指示它們的相鄰節點停止以流的方式發送新塊，因為現在這些節點可以自己生成後續的塊，並擁有原始消息的副本。這些節點繼續以流的方式生成後續塊並將它們發送到它們的相鄰節點， 除非相鄰節點反過來表明不再需要發送。
以這種方式，節點在進一步傳播之前不需要完整地下載大消息。這可以最大限度地減少廣播延
遲，尤其是與3.3.10。中描述的優化結合使用時。

### 3.3.16	基於現有的覆蓋網路構建新的覆蓋網路。

有時人們不想從頭開始構建覆蓋網路。相反已知一個或多個先前存在的覆蓋網路，並且預計新覆蓋網路的成員資格與這些覆蓋網路的組合成員資格顯著重疊。
當一個TON分片鏈被分成兩個，或者兩個兄弟分片鏈被合併為一個時，就會出現一個重要的例子（參見2.7）。在第一種情況下，必須為每個新的分支鏈構建用於將新塊傳播到完整節點的覆蓋網路；然而，可以預期每一個新的覆蓋網路都包含在原始分片鏈的區塊傳播網路中（並且包括其大約一半的成員）。在第二種情況下，用於傳播合併分片鏈的新塊的覆蓋網路，將大概包含兩個覆蓋網路成員的並集，這兩個覆蓋網路與兩個並聯的兄弟鏈有關。
在這種情況下，新覆蓋網路的描述可以包含對相關現有覆蓋網路清單的顯式或隱式引用。希望加入新覆蓋網路的節點可以檢查它是否已經是其中一個現有網路的成員，並且在這些網路中查詢它們的相鄰節點是否也對新網路感興趣。在肯定答覆的情況下，可以為此類相鄰節點建立新的點對點通道，並且這些通道可以包含在相鄰節點清單中用於新覆蓋網路。
這種機制並不完全取代3.3.6和3.3.7中描述的一般機制；相反，它們都是並行運行的，用於填充相鄰節點列表。這是為了防止無意中將新的覆蓋網路分成幾個未連接的子網。

### 3.3.17	帶有覆蓋網路的覆蓋網路。

另一個有趣的案例是TON支付（TON Payments）的實施（即用於即時鏈下價值轉移的 “閃電
網路”；參見 5.2）。在這種情況下，首先構建包含 “閃電網路” 的所有傳輸節點的覆蓋網路。

然而，其中一些節點已在區塊鏈中建立了支付通道；除了是3.3.6、 3.3.7和3.3.8中描述的一般覆蓋網路演算法選擇的任何 “隨機” 相鄰節點之外，它們必須始終是該覆蓋網路中的相鄰節點。這些相鄰節點（帶有已建立的支付通道）的 “永久連結” 用於運行特定的閃電網路通訊協定，從而有效地在包含的（最常連接的）覆蓋網路內創建覆蓋子網（如果出現問題，不一定會連接）。