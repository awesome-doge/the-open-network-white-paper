# 2.7. 拆分和合併分片鏈

TON區塊鏈最具特色、最獨特的功能之一是一個分片能在負載變高時自動將分為兩個，並在負載下降時合二為一(參見 2.1.10)。由於其獨特性和對整個項目擴容的重要性，我們須對此進行詳細討論。

### 2.7.1 分片配置

想一下，在任何給定的時刻，每條工作鏈會被分成一條或幾條分片鏈$(w,s)$(參見 2.1.8)。這些分片鏈可用一個根節點為$(w,∅)$的二叉樹的許多葉子來表示，每個非葉子節點$(w,s)$都有子節點$(w,s.0)$和$(w,s.1)$。通過這種方式，屬於工作鏈 $w$ 的每個帳戶都被具體分配到一個分片，並且知道當前分片鏈配置的人都可以確定包含帳戶 $account_{id}$ 的分片$(w,s)$：它是唯一一個用二進位字元串 $s$ 作為$account_{id}$首碼的分片。
分片配置——即此分片二叉樹，或給定 $w$ 的所有活躍節點$(w,s)$的集合(對應分片 二叉樹 23 的葉子)——是主鏈狀態的一部分，並且可用於所有追蹤主鏈的人。

### 2.7.2 最新的分片配置和狀態

想一下，最新的分片鏈區塊的雜湊值包含在每個主鏈區塊中。這些雜湊值按分片二叉樹(實際上是樹的集合，每個工作鏈一個)排列。這樣每個主鏈區塊都包含最新的分片配置。

### 2.7.3 宣布並執行分片配置和更改

可以通過兩種方式更改分片配置：一個分片$(w,s)$可以分為兩個$(w,s.0)$和$(w,s.1)$，或兩個 "兄弟" 分片$(w,s.0)$和$(w,s.1)$可以合併為一個分片$(w,s)$。
這些拆分 / 合併操作會預先在幾個區塊上公佈(例如，26；這是可配置參數)，首先在相應的分片鏈區塊的 "區塊頭" 中，然後在引用這些分片鏈區塊的主鏈區塊中。所有相關方都需要這種預先公佈，以準備計畫是式更改(例如，如 3.3 中所述，搭建覆蓋多播網路傳播新創建的分片鏈的新區塊)。之後更改得以進行，(在拆分的情況下)首先進入分片鏈區塊的(區塊頭)(在合併的情況下，兩個分片鏈的區塊都應該進行更改)，然後傳播到主鏈區塊。通過這種方式，主鏈區塊不僅定義了創建之前的最新分片配置，還定義了下一個即將分片配置。

---

[23] 實際上，分片配置完全由最後一個主鏈區塊決定；這樣就簡化了分片配置的流程。

---

### 2.7.4 新分片鏈的驗證人任務組

想一下，每個分片(即每個分片鏈)通常配有一個驗證人子集(驗證人任務組)，該子集專門用於創建和驗證相應分片鏈中新的區塊(參見 2.6.8)。這些任務組隔一段時間(大約一小 24 時)選出，並且提前一段時間(大約一小時)知曉，並且在此期間是不可更改。

但是，由於拆分 / 合併操作，實際的分片配置可能會在此期間發生更改。必須將任務組分配給新創建的分片。可通過如下操作：
請注意，任何活躍分片$(w,s)$都將是某些唯一確定的原始分片$(w,s')$的衍生，即$s'$ 是 $s$ 的首碼，或者將是原始分片$(w,s')$的子樹的根，其中 $s$ 將是每個 $s'$ 的首碼。在第一種情況下，我們只需將原始分片$(w,s')$的任務組重新用作新分片$(w,s)$的任務組。在後一種情況下，新分片$(w,s)$的任務組將是所有原始分片$(w,s')$的任務組的並集，這些原始分片都是分片樹中$(w,s)$的衍生。
通過這種方式，每個活躍分片$(w,s)$都有一個明確定義的驗證人子集(任務組)。拆分分片時，兩個子代繼承了原始分片整個任務組。合併兩個分片時，它們的任務組也會合並。

追蹤主鏈狀態的任何人都可以為每個活躍分片計算驗證人任務組。

### 2.7.5	原任務組工作期間限制拆分/合併的操作

最終將考慮新的分片配置，並且將自動為每個分片分配新的專用驗證人子集(任務組)。在此之前，必須對拆分 / 合併操作施加一定的限制；否則，如果原始分片快速分成 $2k$ 個新分片， 則原始任務組可能最終會同時驗證一個很大$k$值的 $2k$ 個分片鏈。
這是通過對從原始分片配置(用於選擇當前負責的驗證人任務組的配置)中刪除活動分片配置的距離施加限制來實現的。例如，如果 $s'$ 是 $s$ 的前身(即$s'$是二進位字元串s的首碼)，則可要求分片樹中從活動分片$(w,s)$到原始分片$(w,s')$的距離不得超過 $3$。如果 $s'$ 是 $s$ 的後代(即 $s$ 是 $s'$ 的首碼，則距離不得超過 $2$。否則，不允許拆分或合併操作。
粗略地說，在給定驗證人任務組的工作期間對分片(例如，三個)或合併(例如，兩個)的次數施加限制。除此之外，在通過合併或拆分創建了一個分片之後，一段時間(一定數量的塊) 內不能重新配置。

### 2.7.6 確定拆分操作的必要性

分片鏈的拆分操作通過某些形式條件觸發(例如，如果連續 $64$ 個區塊，則分片鏈區塊至少滿90％)。這些條件由分片鏈任務組監視。如果滿足這些條件，首先在新的分片鏈區塊的區塊頭中包含"拆分準備"標誌(並且傳播到引用該分片鏈區塊的主鏈區塊)。然後，在幾個區塊之後，"拆分完成"標誌被包含在分片鏈區塊的區塊頭中(並傳播到下一個主鏈區塊)。

---

[24] 除非有些節點由於簽署無效區塊而被暫時或永久禁止，被自動剔除在專案組外。

---

### 2.7.7 執行災分操作

在分片鏈$(w,s)$的區塊 $B$ 中包含"拆分完成"標誌之後，該分片鏈中不會有後續區塊 $B'$。 相反，將分別創建分片鏈$(w,s.0)$和$(w,s.1)$的兩個區塊 $B0′$ and $B1′$ ，兩者都將區塊 $B$ 引用為它們的前一個區塊(並且都將通過塊頭中的flag標記已拆分分片)。下一個主鏈區塊將包含新分片鏈的區塊 $B0'$ 和 $B1'$ 的雜湊值；不允許包含分片鏈$(w,s)$新區塊 $B'$ 的雜湊值，因為"拆分完成"事件已經被提交到先前的主鏈區塊中。
請注意，兩個新的分片鏈將由與舊驗證人相同的驗證人任務組驗證，因此它們將自動獲得其狀態的副本。從無限分片範式(Infinite Sharding Paradigm)的角度來看，狀態拆分操作本身非常簡單(參見 2.5.2)。

### 2.7.8 確定合併操作的必要性。

分片鏈合併操作的必要性可通過某些形式的條件檢測到(例如，對於 $64$ 個連續區塊，兩個兄弟分片鏈區塊的大小之和不超過最大區塊大小的 60％)。這些形式條件還應考慮這些區塊所消耗的總 gas，並將其與當前區塊 gas限制進行比較，否則區塊可能會很小，因為有一些計算密集型交易會阻止更多的交易。

這些條件由兄弟分片$(w,s.0)$和($w,s.1)$的驗證人任務組監視。請注意，兄弟分片必須是超立方體路由的相連分片(參見 2.4.19)，因此來自任一分片的任務組的驗證人將在某種程度上監視兄弟分片。
當這些條件得到滿足時，任何一個驗證人子組都可以通過發送特殊消息向另一個驗證人建議它們進行合併。然後，它們組合成一個臨時的 "合併任務組"，具有組合的成員能夠運行 BFT 共識演算法，並在必要時傳播區塊更新和區塊候選。
如果它們就合併的必要性和準備情況達成共識，則 "合併準備" 標誌將被提交到每個分片鏈的某些區塊的區塊頭中，同時還有兄弟任務組至少三分之二的驗證人的簽名(並傳播到下一個主鏈區塊，以便每個人都可以為即將進行的重新配置做好準備)。但是，它們繼續為某些預定義數量的區塊創建單獨的分片鏈區塊。

### 2.7.9 Performing merge operations

之後，當來自兩個原始任務組的驗證人準備好成為合併的分片鏈的驗證人時(這可能涉及從兄弟分片鏈轉移樁體和狀態合併操作)，將提交"合併完成"標誌至它們分片鏈區塊的區塊頭中(此事件傳播到下一個主鏈區塊)，並停止在單獨的分片鏈中創建新區塊(一旦出現合併完成標誌，則禁止在單獨的分片鏈中創建區塊)。反之，則創建一個合併的分片鏈區塊(由兩個原始任務組的並集)，在其"區塊頭"中引用它的兩個 "前區塊"。這反映在下一個主鏈區塊中，它將包含合併分片鏈區塊新創建的的雜湊值。之後，合併的任務組繼續在合併的分片鏈中創建區塊。